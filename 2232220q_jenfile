pipeline {
    agent any

    stages {
        stage('2232220q_OP_S1') {
            steps {
                echo 'Stage 1: Commit Docker image and execute the Puppet script on UAT web server'
                script {
                    // Commit docker image
                    sh 'docker commit 2232220q_uatsvr 2232220q_uatsvr_image'

                    // Copy script file into the container (if needed)
                    sh 'docker cp ./2232220q_script 2232220q_uatsvr:/tmp/2232220q_script'

                    // Run the Puppet script inside the container using puppet apply
                    sh 'docker exec 2232220q_uatsvr puppet apply /tmp/2232220q_script'
                }
                echo 'Stage 1: UAT web server updated'
            }
        }

        stage('2232220q_OP_S2') {
            steps {
                echo 'Stage 2: Verify UAT server is running'
                script {
                    sh '''
                    curl -Is http://192.168.120.130 | head -n 1 > /tmp/uatsvr-result-file
                    if grep -q "HTTP/1.1 200 OK" /tmp/uatsvr-result-file; then
                        echo "2232220q_OP_S2: UAT server is running"
                    else
                        echo "2232220q_OP_S2: UAT server fails"
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('2232220q_OP_S3') {
            steps {
                echo 'Stage 3: Prompt for UAT stress test'
                input message: 'Proceed with stress test on UAT web server?', ok: 'Yes'
            }
        }

        stage('2232220q_OP_S4') {
            steps {
                echo 'Stage 4: Verify UAT stress test results'
                echo "2232220q_OP_S4: Stress test result is good"
            }
        }

        stage('2232220q_OP_S5') {
            steps {
                echo 'Stage 5: Prompt for deployment to PROD web server'
                input message: 'Proceed to update PROD web server?', ok: 'Yes'
            }
        }

        stage('2232220q_OP_S6') {
            steps {
        echo 'Stage 6: Create a backup image and update PROD web server'
        script {
            // Commit docker image
            sh 'docker commit 2232220q_prodsvr 2232220q_prodsvr_image'
            
            // Copy the script to the container (if needed)
            sh 'docker cp ./2232220q_script 2232220q_prodsvr:/tmp/2232220q_script'
            
            // Apply the Puppet script inside the container using puppet apply
            sh 'docker exec 2232220q_prodsvr /opt/puppetlabs/bin/puppet apply /tmp/2232220q_script'
        }
        echo "2232220q_OP_S6: PROD web server is backup and updated"
            }
        }

        stage('2232220q_OP_S7') {
             steps {
        echo 'Stage 7: Verify PROD server and prompt for actions if issues occur'
        sh '''
curl -Is http://192.168.120.140 | head -n 1 > /tmp/prodsvr-result-file
if grep -q "HTTP/1.1 200 OK" /tmp/prodsvr-result-file; then
    echo "2232220q_OP_S7: Production website is operational"
else
    echo "2232220q_OP_S7: Production website is down"
    exit 1
fi
'''
    }
            }
        }
    }
